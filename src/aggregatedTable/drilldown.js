/**
 * Created by IvanP on 11.08.2016.
 */
YUI.add("table-drilldown-menu", function(a) {
  a.DrilldownMenu = function(d) {
    var TableId = d.TableId, MenuId = d.MenuId, CellId = d.CellId, TableIndex = d.TableIndex, f, supposedMenu = a.one('[data-drilldown-menu-id="' + h + '"]>.yui3-menu'), g = function() {
        f.detach();
        supposedMenu.hide();
      }
      , i = function() {
        supposedMenu.setStyle("display", "block").setXY([d.pageX, d.pageY]);
        a.publish("tdd:ready", {
          broadcast: 2
        });
        a.fire("tdd:ready");
        setTimeout(function() {
          a.use("event-outside", function() {
            supposedMenu.once("clickoutside", g);
          });
        }, 0);
      }
      ;
    if (!supposedMenu) {
      drillDownMenuItemClick("", TableId, CellId, null , TableIndex);
      return;
    }
    f = supposedMenu.delegate("click", function(event) {
      g();
      var newPageId = event.currentTarget.getAttribute("data-new-page");
      drillDownMenuItemClick(event.currentTarget.getAttribute("data-menu-item-id"), TableId, CellId, newPageId, TableIndex);
    }, "li > a.yui3-menuitem-content");
    YUI({
      fetchCSS: false
    }).use("yui-later", "node-menunav", function(k) {
      if (!supposedMenu.menuNav) {
        supposedMenu.plug(k.Plugin.NodeMenuNav);
      }
      i();
    });
  }
  ;
});

function drillDownMenuItemClick(DataMenuItemID, TableId, CellId, newPageId, TableIndex) {
  document.ServerForm.CurrentDrillDownMenuItemId.value = DataMenuItemID;
  document.ServerForm.CurrentDrillDownTableId.value = TableId || top.drillDownTableId;
  document.ServerForm.CurrentDrillDownTableIndex.value = TableIndex;
  document.ServerForm.CurrentDrillDownCellId.value = CellId || top.drillDownCellId;
  if (viewmode.ajaxEnabled) {
    Y.Global.fire("tabledrilldown:select", {
      tableId: TableId || top.drillDownTableId,
      cellId: CellId || top.drillDownCellId,
      menuItemId: DataMenuItemID,
      pageId: newPageId,
      tableIndex: TableIndex
    });
  } else {
    viewmode.submit();
  }
}
YUI.add("confirmit-drilldown",function(ab){var C=ab.UA.touchEnabled,aS="dd-lazy-load",t="dd-parent",aM="dd-parent-a",am="dd-ajax-in-progress",aG="dd-drilldown-in-progress",A="dd-current",aT="dd-current-item",aK="dd-selectable",q="dd-selected",aF="dd-checked",f="dd-item-text",m="dd-items",ar="dd-subitems-visible",g="dd-subitems-visible-link",y="dd-header",v="dd-noresults",B="dd-search-input",W="dd-button-select",D="dd-bc-current",V="version",ax="setButtonText",j="cancelText",G="searchPlaceholder",aE="path",aO="gotoTopText",aN="rootNodeId",aq="rootNodeText",S="info",w="noResultsMessage",P="serviceUrl",r="startNodeId",c="selectedNodeId",aB="selectedNodes",aU="topNodes",ad="isMultiSelect",ae="selectedNodeText",z="host",ak="data-id",an="data-table",aH="data-relation",E={},ac=function(){var aW=this,aY=aW.get(aE),Y=aW.get(aN),aX=Q.call(aW);if(ab.Object.isEmpty(aY)){aY=[{id:aW.get(aN),title:aW.get(aq)}];}ab.each(aY,function(a0,aZ){ab.Node.create("<li><a href='#' title='"+(a0.title||a0.id)+"' data-id='"+a0.id+"'>"+(a0.title||a0.id)+"</a></li>").appendTo(aX).on("click",aw,aW,a0.id,Y);});e.call(aW,aX);},e=function(aW){var Y=aW.all(">li");Y.removeClass(D);if(Y.size()>0){Y.slice(-1).addClass(D);}},aw=function(aX,aY,Y){var aW=this;aX.halt();if(al(aX.target)){return;}N.call(aW,aY,true,Y);u.call(aW,aX.target);aa.call(aW,aW.get(z));},al=function(Y){return Y.ancestor("li",true).test("."+D);},Q=function(){var Y=this,aW=Y.get(z).one("."+y);if(!aW.one("ul")){aW.append("<ul class='reportal-clearfix'/>");}return aW.one("ul");},ay=function(){var Y=this;Y.get(z).all("."+y+" ul").remove();},af=function(aZ,a2){var aX=this,aW=aZ.hasClass(m),a1=aW?null:aZ.one("ul"),a0=Q.call(aX),aY;if(aW){aY=ab.Lang.sub("<li><a href='#' title='{text}'>{text}</a></li>",{text:a2});}else{var Y=aZ.one("[data-id]");aY=ab.Lang.sub("<li><a href='#' title='{text}' data-id='{id}'>{text}</a></li>",{text:(a2||Y.getAttribute("title")),id:Y.getAttribute("data-id")});}ab.Node.create(aY).appendTo(a0).on("click",aR,aX,aZ.ancestor("li"),a1);e.call(aX,a0);},U=function(aW){var Y=this;if(aW.hasClass(aS)){aW.removeClass(aS);}af.call(Y,aW);az.call(Y,{parentItem:aW,targetList:aW.one("ul"),previousList:aW.ancestor("ul")});},az=function(aX){var Y=this,aW=Y.get(z);aJ.call(Y,aX.previousList);d.call(Y,aX.parentItem);aX.previousList.removeClass(A).all(">li."+aT).removeClass(aT);if(aX.immediate){O.call(Y,aX.targetList);}else{i.call(Y,aX.targetList,aX.isBack);}},d=function(Y){if(!Y){return;}Y.addClass(ar).one("a").addClass(g);},aJ=function(Y){if(Y){Y.all("."+ar).removeClass(ar);Y.all("."+g).removeClass(g);}},i=function(aY,aW){var Y=this,aX=Y.get(z),aZ=aX.get("offsetWidth");if(aW){aZ=(0-aZ);}aY.setStyle("left",aZ+"px");ab.use("transition",function(){O.call(Y,aY);aY.transition({duration:0.2,left:0,on:{end:function(){aX.removeClass(aG);aX.one("."+m).getDOMNode().scrollTop=0;Y.fire("transitionComplete");}}});});},O=function(aW){var Y=aj.call(this);aW.addClass(A).all(">li").addClass(aT).each(function(aX){var aY=aX.one("a");if(Y.indexOf(aY.getAttribute(ak))>-1){aY.addClass(aF);}});},aR=function(aY,Y,aZ){var aW=this,aX=aY.target,aZ=aZ||aW.get(z).one("."+m).one("ul");if(al(aX)){return;}Z.call(aW,aX,Y,aZ);},Z=function(aX,Y,a0){var aW=this,aZ=aW.get(z),aY=aZ.one("."+A);aa.call(aW,aY);u.call(aW,aX);aJ.call(aW,a0);az.call(aW,{parentItem:Y,previousList:aY,targetList:a0,isBack:true});},u=function(aX){var aW,Y=aX.ancestor("li",true).next();if(!Y){return;}while(aW=Y.next()){Y.remove();Y=aW;}Y.remove();e.call(this,Q.call(this));},ai=function(aX,aW){var Y=this;if(E[aX]){aW.call(Y,E[aX]);return;}ab.io("/cf_clientutil/confirmit-modules/confirmit-drilldown/"+aX+".htm?v="+Y.get(V),{method:"GET",on:{success:function(aZ,aY){E[aX]=ab.Handlebars.compile(aY.responseText);aW.call(Y,E[aX]);}}});},aA=function(a1){var Y=this,aX=Y.get(z),a0=a1.currentTarget,aY=a0.ancestor("li"),aZ=Y.get(S),aW=a0.ancestor("a").getAttribute(ak);aX.addClass(aG);aa.call(Y,aX);if(aY.hasClass(aS)){au.call(Y,aY,aW,aZ);}else{U.call(Y,aY);}},aQ=function(Y){var aX=this.get(z),aW=ab.Node.create(E["drilldown-list"]({items:Y.nodes,listclass:Y.listClass}));Y.appendTo.append(aW);h.call(this,aW);return aW;},au=function(Y,aX,aZ){var aW=this,aY=aW.get(z);Y=Y||aY.one("."+m);aD.call(aW,{data:{nodeId:aX,info:aZ},callback:function(a1,a0,a2){Y.all("ul").remove();aQ.call(aW,{appendTo:Y,nodes:a1,listClass:"dd-sub-menu"});U.call(aW,Y);}});},aP=function(aZ){var aY=this,a1,a0=aZ.target,aW=aY.get(aB),Y=aj.call(this),a3=av.call(aY);aZ.halt();if(a0.get("tagName").toLowerCase()!=="li"){a0=a0.ancestor("li");}if(!aY.get(ad)){a1=a0.hasClass(q);aa.call(aY,a0.ancestor("ul"));aY.set(c,a1?"":a0.addClass(q).one("a").getAttribute(ak));aY.set(ae,a1?"":a0.one("."+f).get("text"));return;}var a2=a0.one("a");a1=a2.hasClass(aF);aa.call(aY,a0.ancestor("ul"));var aX={id:a2.getAttribute(ak),title:a0.one("."+f).get("text"),levelTable:a0.getAttribute(an),levelRelation:a0.getAttribute(aH),path:a3};a0.addClass(q);if(a1){a2.removeClass(aF);aW.splice(Y.indexOf(aX.id),1);aY.fire("remove",{id:aX.id});}else{a2.addClass(aF);aW.push(aX);aY.fire("add",{nodeRefExtended:aX});}ah.call(aY);},ah=function(a0){var Y=this,aX=Y.get(ad),aZ=true;if(aX){var aW=(a0===undefined?Y.get(aB):a0);aZ=(!ab.Lang.isArray(aW)||aW.length==0);}else{var aY=(a0===undefined?Y.get(c):a0);aZ=!aY;}Y.get(z).all("."+W).set("disabled",aZ);if(!aZ){H.call(Y);}},aa=function(Y){this.set(c,"");Y.all("li."+q).removeClass(q);},N=function(a0,aZ,Y){var aX=this,aY=aX.get(z),aW=aY.one("."+m);L.call(aX);aD.call(aX,{data:{nodeId:a0,info:aX.get(S)},callback:function(a2,a1,a5){var a6,a4,a7,a3=aX.get(aU);aW.set("innerHTML","");a6=aQ.call(aX,{appendTo:aW,nodes:a3,listClass:"dd-menu "});a4=a6.one(ab.Lang.sub('[data-id="{id}"]',{id:Y})).ancestor("li");d.call(aX,a4);a7=aQ.call(aX,{appendTo:a4,nodes:a2,listClass:"dd-sub-menu "+A});if(aZ){i.call(aX,a7,aZ);}else{M.call(aX);az.call(aX,{parentItem:a4,targetList:a7,previousList:a6,immediate:true});}aX.fire("ready");}});},M=function(){var aW=this,aX=aW.get(z),Y=aX.one("."+m);af.call(aW,Y,aW.get(aO));},J=null,l=function(Y){if(Y&&J&&J.isInProgress&&J.isInProgress()){J.abort();}J=null;},aD=function(aW){var Y=this,aX=Y.get(z),aY=ab.clone(aW.data||{});aY.isRepBase=this.get("isReportBase");aY.parameter=this.get("reportParameter")||"";aY.PageStateId=ao.call(this);aX.addClass(am);x.call(Y);l.call(Y,true);ab.use("querystring-stringify-simple",function(){ai.call(Y,"drilldown-list",function(aZ){J=ab.io(Y.get(P)+(aW.action||"GetChildNodes")+"?"+ab.QueryString.stringify(aY),{method:"GET",headers:{"Content-Type":"application/json; charset=UTF-8"},on:{start:function(){aI.call(Y,true);},success:function(a2,a1){var a0=ab.JSON.parse(a1.responseText);aW.callback.call(aW.scope||Y,a0,aZ,true);},complete:function(a1,a0){aX.removeClass(am);aI.call(Y,false);l.call(Y);},failure:function(a1,a0){if(a0.statusText=="abort"){return;}x.call(Y,ab.Lang.sub("An error {code} occurred during xhr: {err}",{err:a0.statusText,code:a0.status}));aW.callback.call(aW.scope||Y,[],aZ,false);}}});});});},x=function(aX){var Y=this.get(z),aW=Y.one(".dd-err-msg");if(!aX||0==aX.length){aW.hide();}else{aW.set("text",aX);aW.show();}},h=function(aW){var Y=this;aW.all("."+f).each(function(aX){aX.on("click",aP,Y);});aW.all(".dd-item-marker").each(function(aX){aX.on("click",aP,Y);});aW.all(".dd-expand").each(function(aX){aX.on("click",aA,Y);});},F=function(){var Y=this,aW=Y.get(z);aW.all("."+ar).removeClass(ar);aW.one("."+m+" li").addClass(ar);aW.all("."+g).removeClass(g);},o=function(a2){var aZ=this,aW=aZ.get(c),a7=aZ.get(ae),a1=a2.container.ancestor(),a0=a1.getData("parentId"),a5=this.get("isReportBase"),a4=this.get("reportParameter"),Y=aZ.get(ad),aY=a1.one("."+q),a6=Y?null:aY.getData("table"),aX=Y?null:aY.getData("relation"),a3=this.get(aB);if(!Y&&!aW){return;}if(Y&&(!a3||a3.length==0)){return;}aZ.fire("select",{id:aW,selectedNodes:a3,selectedNodesEncoded:ab.JSON.stringify(Y?ab.Array.map(a3,function(a8){return a8.id;}):[aW]),isMultiSelect:Y,title:a7,path:av.call(aZ),parent:a0,reportBase:a5,parameter:a4,levelTable:a6,levelRelation:aX});},av=function(){var Y=[];this.get(z).all("."+y+" li:not(:first-child) a").each(function(aW){Y.push({id:aW.getAttribute("data-id"),title:aW.getAttribute("title")});});return Y;},I=function(aW){var Y=this;ai.call(Y,"drilldown",function(aX){Y.get(z).setContent(ab.Node.create(aX({setText:Y.get(ax),cancelText:Y.get(j),searchPlaceholder:Y.get(G)})));aW();});},at=function(){var Y=this;ac.call(Y);Y.setSelectedNodeId(Y.get(c));},aC=function(){var Y=this;ab.Handlebars.registerHelper("itemclass",function(){var aW=[],aX=Y.get(c);if(this.selectable){aW.push(aK);if(this.id===aX){aW.push(q);}}if(!this.isLeaf){aW.push(t);aW.push(aS);}return ab.Lang.trim(aW.join(" "));});ab.Handlebars.registerHelper("linkclass",function(){return this.isLeaf?"":aM;});ab.Handlebars.registerHelper("title_with_path",function(){return C?this.title:a(this);});ab.Handlebars.registerHelper("text_with_path_in_touch",function(){if(!C){return this.title;}var aW=a(this);if(aW.length>65){aW="... "+aW.substring(aW.length-60);}return aW;});},a=function(aW){var Y="";ab.each(aW.path,function(aY,aX){Y+=aY.title+" > ";});return Y+aW.title;},b=function(Y){Y.preventDefault();},aV=function(){this.fire("hide");},p=(function(){var Y;return function(){var aW=this,aX=function(aY){if(Y){clearTimeout(Y);}Y=setTimeout(function(){K.call(aW);},300);};ab.mix(ab.Node.DOM_EVENTS,{search:1});aW.get(z).one("."+B).on({keydown:function(aY){if(aY.keyCode===13){aY.halt();return false;}},keyup:aX,change:aX,search:aX});};}()),aI=function(Y){if(n){if(Y){n.show();}else{n.hide();}}},K=function(aZ){var aW=this,aY=aW.get(z),Y=aY.one("."+m),aX=aY.one("."+B),a0=aZ||aX.get("value");if(a0===(aW._lastSearch||"")){return;}aW._lastSearch=a0;if(!aW._lastSearch){N.call(aW,aW.get(r),false,aW.get(aN));ay.call(aW);aW.once("ready",ac,aW);return;}aa.call(aW,aY);ai.call(aW,"drilldown-results",function(a1){aD.call(aW,{action:"Search",data:{nodeId:aW.get(aN),info:aW.get(S),searchValue:aW._lastSearch},callback:function(a3,a2,a4){if(a4){ay.call(aW);X.call(aW,a3,a1,aZ);}}});});},L=function(){ab.each(this._resultHandles||[],function(Y){Y.detach();});this._resultHandles=[];},ag=function(){ab.each(this._mainHandles||[],function(Y){Y.detach();});this._mainHandles=[];},X=function(a0,aY,aX){var aW=this,aZ=aW.get(z),Y=0;L.call(aW);if(aX){ap.call(aW,null,a0[0]);return;}aZ.one("."+m).set("innerHTML",aY({items:a0}));aZ.all("."+v).remove();if(a0.length){aZ.all(".dd-results li").each(function(a1){aW._resultHandles.push(a1.on("click",ap,aW,a0[Y++]));});}else{aZ.one("."+m).append("<div class='"+v+"'>"+aW.get(w)+"</div>");}},ap=function(aW,Y){this.showChildNodes(Y,false);},H=function(){this.get(z).one("."+W).focus();},k=function(a2){var aY=this,a6=aY.get(z),Y="."+aT,a5=Y+" a",aX="."+B,a3=a2.target,aZ=a3.test(a5),a1=a3.test(aX),aW="next",a0;if(a6.one("."+v)){return;}if(a1){a0=a6.one(Y);}switch(a2.keyCode){case 38:aW="previous";if(a1){a0=a6.all(Y).pop();}case 40:if(aZ){a0=a3.ancestor(Y)[aW](Y);}if(a0){a0.one("a").focus();}else{a6.one(aX).focus();}break;case 13:if(aZ){if(a3.ancestor(".dd-results")){a3.one("span").getDOMNode().click();}else{var a4=a3.one("span.dd-expand");if(a4&&a4._isHidden()==false){a4.getDOMNode().click();}}}break;case 32:if(aZ){a3.one("span").getDOMNode().click();}break;case 27:aV.call(aY);break;default:return;}a2.halt();},T=function(aZ){var aW="."+aT,Y=aW+" a",aY=aZ.target,aX=aY.test(Y);switch(aZ.keyCode){case 38:case 40:aZ.halt();break;case 13:case 32:if(aX){aZ.halt();}break;case 27:aZ.halt();break;}},aj=function(){return ab.Array.map(this.get(aB),function(Y){return Y.id;});},ao=function(){var Y=ab.one("#PageStateId");return Y?Y.get("value"):"";},n=null,aL=null,R=[],s=function(){var Y=this;s.superclass.constructor.apply(Y,arguments);Y.publish("select",{broadcast:2});Y.publish("add");Y.publish("remove");Y.publish("hide");Y.publish("ready");};ab.extend(s,ab.Plugin.Base,{initializer:function(){var Y=this,aW=Y.get(z);ab.use("cssbutton");R.push(aW.delegate("click",b,"a"));R.push(aW.delegate("click",ab.bind(o,Y),"."+W));R.push(aW.delegate("click",ab.bind(aV,Y),".dd-cancel"));R.push(aW.delegate("click",ab.bind(F,Y),"."+y+" ul li:first-child a"));R.push(aW.on("keyup",ab.bind(k,Y)));R.push(aW.on("keydown",ab.bind(T,Y)));Y.once("ready",ab.bind(at,Y));Y.once("ready",ab.bind(p,Y));aC.call(Y);I.call(Y,function(){var aX=Y.get(z).one("."+m);aX.plug(ab.AjaxProgress,{});n=aX["ajax-progress"];N.call(Y,Y.get(r),false,Y.get(aN));});},destructor:function(){var Y=this.get(z).one("."+m);if(Y&&ab.AjaxProgress&&Y.hasPlugin("ajax-progress")){Y.unplug(ab.AjaxProgress);}n=null;L.call(this);ag.call(this);if(aL){aL.detach(),aL=null;}},showChildNodes:function(aY,a2){var Y=this,a0=Y.get(z),a1=aY.path,aX;if(aX=ab.Object.isEmpty(a1)){a1=[{id:aY.id,title:aY.title}];}var aW=a1[0],aZ=a1.slice(-1)[0];Y.get(z).one("."+B).set("value",Y._lastSearch="");Y.set(aE,a1).set(r,aZ.id).set(c,aY.id).set(ae,aY.title).set(aN,aW.id).set(aq,aW.title);if(a2){ay.call(Y);}if(aL){aL.detach();}aL=Y.once("ready",function(){aL=null;at.call(Y);if(aX){Y.once("transitionComplete",function(){Y.setSelectedNodeId(aY.id);});Z.call(Y,Q.call(Y).one("a"),null,a0.one(".dd-menu"));}else{Y.setSelectedNodeId(aY.id);}});N.call(Y,aZ.id,false,aW.id);},removeNode:function(a0){var Y=this,aZ=Y.get(z),aY=aZ.one('[data-id="'+a0+'"]');if(aY){aY.removeClass(aF);}var aW=this.get(aB),aX=aj.call(this);aW.splice(aX.indexOf(a0),1);Y.fire("remove",{id:a0});ah.call(Y);},setSelectedNodeId:function(aY){var Y=this,aX=Y.get(z),aW;aa.call(Y,aX);aW=aX.one("."+A+" a["+ak+"='"+aY+"']");if(aW){aW.ancestor("li").addClass(q).one("a").focus();}Y.set(c,aY);}},{NS:"drilldown",NAME:"drilldown",ATTRS:{isMultiSelect:false,serviceUrl:"",startNodeId:"",selectedNodeId:{setter:function(Y){if(this.get(ad)==false){ah.call(this,Y);}return Y;}},noResultsMessage:"",selectedNodeText:"",info:"",rootNodeId:"",rootNodeText:"",gotoTopText:"",version:"",setButtonText:"",cancelText:"",searchPlaceholder:"",path:[],selectedNodes:{value:[],setter:function(Y){if(this.get(ad)==true){ah.call(this,Y);}return Y;}},topNodes:[],isReportBase:false,reportParameter:null}});ab.DrillDown=s;},"1",{requires:["confirmitcss-drilldown","io-base","json","handlebars","node-screen","plugin","node-base","node-style","node-pluginhost","node-event-delegate","attribute-base","array-extras","confirmit-ajax-progress"]});
